{
  "id": "miv_grant",
  "script": {
    "lang": "mustache",
    "source": {
      "query": {
        "bool": {
          "filter": {
            "bool":{
              "must": [
                { "term" : {"id": "expert/{{md5}}" } }
              ]
            }
          },
          "must":{
            "nested": {
              "path": "@graph",
              "query": {
                "bool" : {
                  "filter": [
                    {
                      "bool": {
                        "should":[
                          {
                            "bool": {
                              "must": [
                                { "exists": { "field": "@graph.@type" }},
                                { "term": { "@graph.is-visible": true }}
                              ]
                            }
                          },
                          {
                            "bool": {
                              "must": [
                                { "exists": { "field": "@graph.relatedBy.is-visible" }},
                                { "term": { "@graph.relatedBy.is-visible": true }}
                              ]
                            }
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "inner_hits": {
                "size": "{{inner_hits_size}}{{^inner_hits_size}}5000{{/inner_hits_size}}",
                "_source": [
                  "@graph.@type",
                  "@graph.name"
                ]
              },
              "score_mode": "sum"
            }
          }
        }
      },
      "_source": [
        "@id",
        "contactInfo"
      ],
      "sort": [
        "_score"
      ],
      "from": "{{from}}{{^from}}0{{/from}}",
      "size": "{{size}}{{^size}}10{{/size}}"
    },
    "params": {
      "md5": "My query string"
    }
  }
}
